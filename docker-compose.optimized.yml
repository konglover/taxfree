version: '3.8'

# 优化版 Docker Compose 配置 - 适用于低配置服务器（1核CPU、1G内存、5G硬盘）
# 优化点：
# 1. 限制容器内存和 CPU 使用
# 2. 使用优化的 Dockerfile
# 3. 配置日志轮转，防止磁盘占满
# 4. 优化健康检查间隔
# 5. 设置容器重启策略

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend.optimized
    container_name: taxfree-backend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - JWT_SECRET=${JWT_SECRET:-your-secret-key-change-this}
    volumes:
      - ./backend/data:/app/data
    networks:
      - taxfree-network
    
    # 资源限制（关键优化）
    deploy:
      resources:
        limits:
          cpus: '0.5'        # 限制使用 50% CPU
          memory: 256M       # 限制内存 256MB
        reservations:
          cpus: '0.25'       # 预留 25% CPU
          memory: 128M       # 预留 128MB 内存
    
    # 日志配置（防止日志占满磁盘）
    logging:
      driver: "json-file"
      options:
        max-size: "10m"      # 单个日志文件最大 10MB
        max-file: "3"        # 最多保留 3 个日志文件
    
    # 健康检查（优化间隔）
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 60s          # 增加间隔以减少资源消耗
      timeout: 5s
      retries: 3
      start_period: 15s

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend.optimized
    container_name: taxfree-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - taxfree-network
    environment:
      - VITE_API_BASE_URL=${VITE_API_BASE_URL:-http://localhost:3000/api}
    
    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '0.3'        # 限制使用 30% CPU
          memory: 128M       # 限制内存 128MB
        reservations:
          cpus: '0.15'       # 预留 15% CPU
          memory: 64M        # 预留 64MB 内存
    
    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "5m"       # 单个日志文件最大 5MB
        max-file: "2"        # 最多保留 2 个日志文件
    
    # 健康检查
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 60s
      timeout: 3s
      retries: 3
      start_period: 10s

networks:
  taxfree-network:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1500

# 卷配置（可选：如果需要持久化日志）
# volumes:
#   backend-data:
#     driver: local
